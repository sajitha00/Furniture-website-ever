name: CI/CD Pipeline - Production Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_NAME_CLIENT: furniture-client
  IMAGE_NAME_SERVER: furniture-api

jobs:
  # Build and Push Docker Images
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata for Client
        id: meta-client
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_CLIENT }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Client image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile
          push: true
          tags: ${{ steps.meta-client.outputs.tags }}
          labels: ${{ steps.meta-client.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            NEXT_PUBLIC_SUPABASE_BUCKET=furniture

      - name: Extract metadata for Server
        id: meta-server
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_SERVER }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Server image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: ${{ steps.meta-server.outputs.tags }}
          labels: ${{ steps.meta-server.outputs.labels }}

  # Deploy to Production VPS
  deploy-to-vps:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create production .env file
        run: |
          cat << EOF > .env
          # Database
          DATABASE_URL=${{ secrets.PROD_DATABASE_URL }}
          
          # Server Configuration
          PORT=5000
          NODE_ENV=production
          
          # JWT Configuration
          JWT_SECRET=${{ secrets.PROD_JWT_SECRET }}
          JWT_EXPIRES_IN=7d
          
          # CORS Configuration
          ALLOWED_ORIGINS=${{ secrets.PROD_ALLOWED_ORIGINS }}
          
          # API URL
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          
          # Supabase Configuration
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SUPABASE_BUCKET=furniture
          
          # Docker Images
          DOCKER_USERNAME=${{ env.DOCKER_USERNAME }}
          IMAGE_CLIENT=${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_CLIENT }}:latest
          IMAGE_SERVER=${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_SERVER }}:latest
          EOF
          
          # Display .env (without sensitive values)
          echo "‚úì Environment file created"
          
          # Encode to base64
          base64 .env > .env.b64

      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: ".env.b64,docker-compose.yml"
          target: ${{ secrets.VPS_DEPLOY_PATH || '/opt/furniture-website' }}

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            # Navigate to deployment directory
            cd ${{ secrets.VPS_DEPLOY_PATH || '/opt/furniture-website' }}
            
            echo " Setting up environment variables..."
            # Decode base64 .env file
            base64 -d .env.b64 > .env
            chmod 600 .env
            rm .env.b64
            
            echo "üìã Verifying docker-compose.yml..."
            if [ ! -f docker-compose.yml ]; then
              echo "‚ùå docker-compose.yml not found!"
              exit 1
            fi
            
            echo "‚úì docker-compose.yml found"
            
            echo "üîë Logging into Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin
            
            echo "üê≥ Pulling latest Docker images..."
            docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_CLIENT }}:latest
            docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_SERVER }}:latest
            
            echo "üõë Stopping old containers..."
            docker compose down
            
            echo "üöÄ Starting new containers..."
            docker compose up -d
            
            echo "‚è≥ Waiting for services to start..."
            sleep 15
            
            echo "üìä Container status:"
            docker compose ps
            
            echo "üßπ Cleaning up old images..."
            docker image prune -af --filter "until=24h"
            
            echo "‚úÖ Deployment completed successfully!"

      - name: Verify Deployment Health
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            cd ${{ secrets.VPS_DEPLOY_PATH || '/opt/furniture-website' }}
            
            echo "üè• Performing health checks..."
            
            # Wait a bit more for services to fully start
            sleep 10
            
            # Check if containers are running
            if ! docker compose ps | grep -q "Up"; then
              echo "‚ùå Containers are not running properly!"
              docker compose ps
              docker compose logs --tail=50
              exit 1
            fi
            
            # Check server health
            echo "Checking Server API health..."
            if curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "‚úÖ Server is healthy"
            else
              echo "‚ö†Ô∏è  Server health check failed (might still be starting)"
              docker compose logs api --tail=30
            fi
            
            # Check client health
            echo "Checking Client health..."
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "‚úÖ Client is healthy"
            else
              echo "‚ö†Ô∏è  Client health check failed (might still be starting)"
              docker compose logs client --tail=30
            fi
            
            echo ""
            echo "üéâ Deployment verification complete!"
            echo "üìÖ Deployed at: $(date)"
            echo "üîñ Commit: ${{ github.sha }}"
            echo "üåø Branch: ${{ github.ref_name }}"

      - name: Send deployment notification
        if: always()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            cd ${{ secrets.VPS_DEPLOY_PATH || '/opt/furniture-website' }}
            
            echo "======================================"
            echo "üìä Deployment Summary"
            echo "======================================"
            echo "Status: ${{ job.status }}"
            echo "Repository: ${{ github.repository }}"
            echo "Commit: ${{ github.sha }}"
            echo "Branch: ${{ github.ref_name }}"
            echo "Deployed by: ${{ github.actor }}"
            echo "Timestamp: $(date)"
            echo "======================================"
            
            # Show running containers
            echo ""
            echo "üê≥ Running Containers:"
            docker compose ps
            
            # Show recent logs if deployment failed
            if [ "${{ job.status }}" != "success" ]; then
              echo ""
              echo "üìã Recent Logs:"
              docker compose logs --tail=50
            fi

  # Cleanup old workflow runs
  cleanup:
    name: Cleanup Old Workflow Runs
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: deploy-to-vps
    
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10